name: $(date:yyyyMMdd)$(rev:.r)

trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: Build artefacts
    jobs:
    - job: ImagePacker
      displayName: Image builder
      steps:
      - task: PackerBuild@1
        displayName: 'Build immutable image'
        inputs:
          ConnectedServiceName: 'JJ Microsoft Azure Internal Consumption (82fb79bf-ee69-4a57-a76c-26153e544afe)'
          managedImageName: 'jjvmimagelx-$(Build.BuildNumber)'
          location: westeurope
          storageAccountName: jjpackerstorage
          azureResourceGroup: jjpacker-rg
          baseImage: 'Canonical:UbuntuServer:18.04-LTS:linux'
          packagePath: packer
          deployScriptPath: deploy.sh

  - stage: DeployDEV
    displayName: Deploy to DEV
    dependsOn: Build
    jobs:
      - deployment: DeployDEV
        displayName: Deploy to DEV
        environment: 'DEV'
        strategy:
          runOnce:
            deploy:
              steps:     
              - task: AzureResourceManagerTemplateDeployment@3
                inputs:
                  deploymentScope: 'Resource Group'
                  azureResourceManagerConnection: 'JJ Microsoft Azure Internal Consumption (82fb79bf-ee69-4a57-a76c-26153e544afe)'
                  subscriptionId: '82fb79bf-ee69-4a57-a76c-26153e544afe'
                  action: 'Create Or Update Resource Group'
                  resourceGroupName: 'jjdevv2vmapplx-rg'
                  location: 'West Europe'
                  templateLocation: 'Linked artifact'
                  csmFile: 'template/deploy.json'
                  csmParametersFile: 'template/deploy.parameters.json'
                  overrideParameters: '-adminPassword $(adminPassword) -imageName jjvmimagelx-$(Build.BuildNumber)'
                  deploymentMode: 'Incremental'